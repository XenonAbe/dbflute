${database.allClassCopyright}package ${glPackageBaseCommonDBMeta};

#set ($myClassName = "${glDBMetaInstanceHandlerName}")
#set ($instanceMapGenericDefinition = "String, ${glDBMetaInterfaceName}")

import java.util.Map;
import java.util.LinkedHashMap;

/**
 * DBMeta instance handler.
 * 
 * @author ${database.ClassAuthor}
 */
public class ${myClassName} {

    /** The key-to-lower map of db-name and property-name for table. */
    protected static final Map${database.filterGenericsString('String, String')} _tableDbNamePropertyNameKeyToLowerMap;
    static {
        Map${database.filterGenericsString('String, String')} tmpMap = new LinkedHashMap${database.filterGenericsString('String, String')}();

#foreach ($table in $database.Tables)
        tmpMap.put("${table.name}".toLowerCase(), "${table.javaBeansRulePropertyName}");
#end

        _tableDbNamePropertyNameKeyToLowerMap = java.util.Collections.unmodifiableMap(tmpMap);
    }

    /** The key-to-lower map of property-name and db-name for table. */
    protected static final Map${database.filterGenericsString('String, String')} _tablePropertyNameDbNameKeyToLowerMap;
    static {
        Map${database.filterGenericsString('String, String')} tmpMap = new LinkedHashMap${database.filterGenericsString('String, String')}();

#foreach ($table in $database.Tables)
        tmpMap.put("${table.javaBeansRulePropertyName}".toLowerCase(), "${table.name}");
#end

        _tablePropertyNameDbNameKeyToLowerMap = java.util.Collections.unmodifiableMap(tmpMap);
    }

    /** Table db-name instance map. */
    protected static final Map${database.filterGenericsString(${instanceMapGenericDefinition})} _tableDbNameInstanceMap;
    static {
        Map${database.filterGenericsString(${instanceMapGenericDefinition})} tmpMap = new LinkedHashMap${database.filterGenericsString(${instanceMapGenericDefinition})}();

#foreach ($table in $database.Tables)
        tmpMap.put("${table.Name}", getDBMeta("${table.DBMetaFullClassName}"));
#end

        _tableDbNameInstanceMap = java.util.Collections.unmodifiableMap(tmpMap);
    }

#if ($database.isMakeRecentlyDeprecated())
    /**
     * @deprecated
     */
    protected static final Map${database.filterGenericsString(${instanceMapGenericDefinition})} _tableCapPropNameInstanceMap;
    static {
        Map${database.filterGenericsString(${instanceMapGenericDefinition})} tmpMap = new LinkedHashMap${database.filterGenericsString(${instanceMapGenericDefinition})}();

#foreach ($table in $database.Tables)
        tmpMap.put("${table.JavaName}", getDBMeta("${table.DBMetaFullClassName}"));
#end

        _tableCapPropNameInstanceMap = java.util.Collections.unmodifiableMap(tmpMap);
    }

    /**
     * @deprecated
     */
    protected static final Map${database.filterGenericsString(${instanceMapGenericDefinition})} _tableUncapPropNameInstanceMap;
    static {
        Map${database.filterGenericsString(${instanceMapGenericDefinition})} tmpMap = new LinkedHashMap${database.filterGenericsString(${instanceMapGenericDefinition})}();

#foreach ($table in $database.Tables)
        tmpMap.put("${table.UncapitalisedJavaName}", getDBMeta("${table.DBMetaFullClassName}"));
#end

        _tableUncapPropNameInstanceMap = java.util.Collections.unmodifiableMap(tmpMap);
    }
#end

    protected static ${glDBMetaInterfaceName} getDBMeta(String className) {
        try {
            final Class clazz = Class.forName(className);
            final java.lang.reflect.Method methoz = clazz.getMethod("getInstance", (Class[])null);
            final Object result = methoz.invoke(null, (Object[])null);
            return (${glDBMetaInterfaceName})result;
        } catch (Exception e) {
            throw new RuntimeException(e);
        }
    }


    /**
     * Find dbmeta by table flexible-name.
     * <pre>
     * If the table name is 'ORDER_DETAIL', you can find the dbmeta by ...(as follows)
     *     'ORDER_DETAIL', 'ORDer_DeTAiL', 'order_detail'
     *     , 'OrderDetail', 'orderdetail', 'oRderDetaIl'
     * </pre>
     * @param tableFlexibleName Table flexible-name. (NotNull)
     * @return Instance. (NotNull)
     */
    public static ${glDBMetaInterfaceName} findDBMeta(String tableFlexibleName) {
        assertStringNotNullAndNotTrimmedEmpty("tableFlexibleName", tableFlexibleName);
        if (_tableDbNameInstanceMap.containsKey(tableFlexibleName)) {
            return byTableDbName(tableFlexibleName);
        }
        final String toLowerKey = tableFlexibleName.toLowerCase();
        if (_tableDbNamePropertyNameKeyToLowerMap.containsKey(toLowerKey)) {
            final String propertyName = (String)_tableDbNamePropertyNameKeyToLowerMap.get(toLowerKey);
            final String dbName = (String)_tablePropertyNameDbNameKeyToLowerMap.get(propertyName.toLowerCase());
            return byTableDbName(dbName);
        }
        if (_tablePropertyNameDbNameKeyToLowerMap.containsKey(toLowerKey)) {
            final String dbName = (String)_tablePropertyNameDbNameKeyToLowerMap.get(toLowerKey);
            return byTableDbName(dbName);
        }
        String msg = "The instance map returned null by the key: key=" + tableFlexibleName + " instanceMap=" + _tableDbNameInstanceMap;
        throw new IllegalStateException(msg);
    }

    /**
     * Get instance by table db-name.
     * 
     * @param tableDbName Table db-name. (NotNull)
     * @return Instance. (NotNull)
     */
    protected static ${glDBMetaInterfaceName} byTableDbName(String tableDbName) {
        assertStringNotNullAndNotTrimmedEmpty("tableDbName", tableDbName);
        final ${glDBMetaInterfaceName} instance = (${glDBMetaInterfaceName})_tableDbNameInstanceMap.get(tableDbName);
        if (instance == null) {
            String msg = "The instance map returned null by the key: key=" + tableDbName + " instanceMap=" + _tableDbNameInstanceMap;
            throw new IllegalStateException(msg);
        }
        return instance;
    }

#if ($database.isMakeRecentlyDeprecated())
    /**
     * Get instance by table db-name.
     * 
     * @param tableDbName Table db-name. (NotNull)
     * @return Instance. (NotNull)
     * @deprecated Please use findDBMeta()
     */
    public static ${glDBMetaInterfaceName} getInstanceByTableDbName(String tableDbName) {
        assertStringNotNullAndNotTrimmedEmpty("tableDbName", tableDbName);
        final ${glDBMetaInterfaceName} instance = (${glDBMetaInterfaceName})_tableDbNameInstanceMap.get(tableDbName);
        if (instance == null) {
            String msg = "The instance map returned null by the key: key=" + tableDbName + " instanceMap=" + _tableDbNameInstanceMap;
            throw new IllegalStateException(msg);
        }
        return instance;
    }

    /**
     * Get instance by table cap-prop-name.
     * 
     * @param tableCapPropName Table cap-prop-name. (NotNull)
     * @return Instance. (NotNull)
     * @deprecated Please use findDBMeta()
     */
    public static ${glDBMetaInterfaceName} getInstanceByTableCapPropName(String tableCapPropName) {
        assertStringNotNullAndNotTrimmedEmpty("tableCapPropName", tableCapPropName);
        final ${glDBMetaInterfaceName} instance = (${glDBMetaInterfaceName})_tableCapPropNameInstanceMap.get(tableCapPropName);
        if (instance == null) {
            String msg = "The instance map returned null by the key: key=" + tableCapPropName + " instanceMap=" + _tableCapPropNameInstanceMap;
            throw new IllegalStateException(msg);
        }
        return instance;
    }

    /**
     * Get instance by table uncap-prop-name.
     * 
     * @param tableUncapPropName Table uncap-prop-name. (NotNull)
     * @return Instance. (NotNull)
     * @deprecated Please use findDBMeta()
     */
    public static ${glDBMetaInterfaceName} getInstanceByTableUncapPropName(String tableUncapPropName) {
        assertStringNotNullAndNotTrimmedEmpty("tableUncapPropName", tableUncapPropName);
        final ${glDBMetaInterfaceName} instance = (${glDBMetaInterfaceName})_tableUncapPropNameInstanceMap.get(tableUncapPropName);
        if (instance == null) {
            String msg = "The instance map returned null by the key: key=" + tableUncapPropName + " instanceMap=" + _tableUncapPropNameInstanceMap;
            throw new IllegalStateException(msg);
        }
        return instance;
    }

    /**
     * Get instance by table uncap-prop-name.
     * 
     * @param tableMultiName Table multi-name. (NotNull)
     * @return Instance. (NotNull)
     * @deprecated Please use findDBMeta()
     */
    public static ${glDBMetaInterfaceName} getInstanceByTableMultiName(String tableMultiName) {
        assertStringNotNullAndNotTrimmedEmpty("tableMultiName", tableMultiName);
        {
            final ${glDBMetaInterfaceName} instance = (${glDBMetaInterfaceName})_tableDbNameInstanceMap.get(tableMultiName);
            if (instance != null) {
                return instance;
            }
        }
        {
            final ${glDBMetaInterfaceName} instance = (${glDBMetaInterfaceName})_tableCapPropNameInstanceMap.get(tableMultiName);
            if (instance != null) {
                return instance;
            }
        }
        {
            final ${glDBMetaInterfaceName} instance = (${glDBMetaInterfaceName})_tableUncapPropNameInstanceMap.get(tableMultiName);
            if (instance != null) {
                return instance;
            }
        }
        String msg = "The tableMultiName does not exist in all-instance-map: tableMultiName=" + tableMultiName;
        msg = msg + " tableDbNameInstanceMap=" + _tableDbNameInstanceMap;
        msg = msg + " tableCapPropNameInstanceMap=" + _tableCapPropNameInstanceMap;
        msg = msg + " tableUncapPropNameInstanceMap=" + _tableUncapPropNameInstanceMap;
        throw new IllegalStateException(msg);
    }
#end

    // ----------------------------------------------------------------
    //                                                    Assert Object
    //                                                    -------------
    /**
     * Assert that the argument is not null.
     * 
     * @param variableName Variable name. (NotNull)
     * @param arg Argument. (NotNull)
     */
    protected static void assertObjectNotNull(String variableName, Object arg) {
        if (variableName == null) {
            String msg = "Argument[variableName] should not be null.";
            throw new IllegalArgumentException(msg);
        }
        if (arg == null) {
            String msg = "Argument[" + variableName + "] should not be null.";
            throw new IllegalArgumentException(msg);
        }
    }

    // ----------------------------------------------------------------
    //                                                    Assert String
    //                                                    -------------
    /**
     * Assert that the string is not null and not trimmed empty.
     * 
     * @param variableName Variable name. (NotNull)
     * @param value Value. (NotNull)
     */
    protected static void assertStringNotNullAndNotTrimmedEmpty(String variableName, String value) {
        if (variableName == null) {
            String msg = "Variable[variableName] should not be null.";
            throw new IllegalArgumentException(msg);
        }
        if (value == null) {
            String msg = "Variable[" + variableName + "] should not be null.";
            throw new IllegalArgumentException(msg);
        }
        if (value.trim().length() == 0) {
            String msg = "Variable[" + variableName + "] should not be empty: [" + value + "]";
            throw new IllegalArgumentException(msg);
        }
    }
}
