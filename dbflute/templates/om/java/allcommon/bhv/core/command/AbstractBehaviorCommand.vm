${database.allClassCopyright}package ${glPackageBaseCommonBhvCoreCommand};

import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;
import javax.sql.DataSource;

import org.seasar.extension.jdbc.ResultSetHandler;
import org.seasar.extension.jdbc.StatementFactory;
import org.seasar.extension.jdbc.ValueType;
import org.seasar.extension.jdbc.types.ValueTypes;
import org.seasar.dao.BeanMetaData;
import org.seasar.dao.BeanMetaDataFactory;
import org.seasar.dao.ValueTypeFactory;

import ${glPackageBaseCommon}.${glEntityInterfaceName};
import ${glPackageBaseCommonBhvCore}.${glBehaviorCommand};
import ${glPackageBaseCommonBhvCore}.${glBehaviorCommandComponentSetup};
import ${glPackageBaseCommonBhvCore}.${glSqlExecution};
import ${glPackageBaseCommonCBean}.${glConditionBeanContextName};
import ${glPackageBaseCommonCBeanOutsidesql}.${glOutsideSqlContextName};
import ${glPackageBaseCommonS2Dao}.${glSelectDynamicCommand};
import ${glPackageBaseCommonS2DaoInternalRsHandler}.${glInternalBeanListMetaDataResultSetHandler};
import ${glPackageBaseCommonS2DaoInternalSqlCommand}.${glInternalProcedureCommand};
import ${glPackageBaseCommonS2DaoInternalSqlCommand}.${glInternalUpdateDynamicCommand};
import ${glPackageBaseCommonS2DaoInternalVarious}.${glInternalProcedureMetaData};
import ${glPackageBaseCommonS2DaoInternalVarious}.${glInternalProcedureMetaDataFactory};
import ${glPackageBaseCommonS2DaoInternalVarious}.${glInternalRowCreator};
import ${glPackageBaseCommonS2DaoInternalVarious}.${glInternalRelationRowCreator};

/**
 * @author ${database.ClassAuthor}
 */
public abstract class ${glAbstractBehaviorCommand} implements ${glBehaviorCommand}, ${glBehaviorCommandComponentSetup} {

    // ===================================================================================
    //                                                                           Attribute
    //                                                                           =========
    // -----------------------------------------------------
    //                                     Basic Information
    //                                     -----------------
    /** The type of entity. (Required) */
    protected Class<? extends ${glEntityInterfaceName}> _entityType;

    /** The table DB-name. (Required) */
    protected String _tableDbName;

    /** Is it initialize only? (Choice) */
    protected boolean _initializeOnly;

    // -----------------------------------------------------
    //                                   Injection Component
    //                                   -------------------
    protected DataSource _dataSource;
    protected StatementFactory _statementFactory;
    protected BeanMetaDataFactory _beanMetaDataFactory;
    protected ValueTypeFactory _valueTypeFactory;
    protected String _sqlFileEncoding;

    // ===================================================================================
    //                                                                             Factory
    //                                                                             =======
    // -----------------------------------------------------
    //                                          BeanMetaData
    //                                          ------------
    protected BeanMetaData createBeanMetaData() {
        return _beanMetaDataFactory.createBeanMetaData(_entityType);
    }

    // -----------------------------------------------------
    //                                          SqlExecution
    //                                          ------------
    protected ${glSqlExecution} createSelectCBExecution(Class<?> cbType, ResultSetHandler handler) { // for condition-bean
        return createSelectDynamicCommand(handler, new String[] { "dto" }, new Class<?>[] { cbType }, null);
    }

    protected ${glSqlExecution} createOutsideSqlSelectExecution(${glOutsideSqlContextName} outsideSqlContext) {
        // - - - - - - - - - - - - - - - - - - - - - - -
        // The attribute of Specified-OutsideSqlContext.
        // - - - - - - - - - - - - - - - - - - - - - - -
        final String suffix = buildDbmsSuffix();
        final String sql = outsideSqlContext.readFilteredOutsideSql(_sqlFileEncoding, suffix);
        final Object pmb = outsideSqlContext.getParameterBean();

        // - - - - - - - - - - - - - - -
        // The attribute of SqlCommand.
        // - - - - - - - - - - - - - - -
        final String[] argNames = (pmb != null ? new String[] {"pmb"} : new String[]{});
        final Class<?>[] argTypes = (pmb != null ? new Class<?>[] {pmb.getClass()} : new Class<?>[]{});

        // - - - - - - - - - - - - - - - -
        // Create customized BeanMetaData.
        // - - - - - - - - - - - - - - - -
        final BeanMetaData bmd = createBeanMetaData();
        final ResultSetHandler handler = createOutsideSqlBeanListResultSetHandler(bmd);

        // - - - - - - - - - -
        // Create Sql-Command.
        // - - - - - - - - - -
        return createSelectDynamicCommand(handler, argNames, argTypes, sql);
    }

    protected ${glSqlExecution} createOutsideSqlExecuteExecution(${glOutsideSqlContextName} outsideSqlContext) {
        // - - - - - - - - - - - - - - - - - - - - - - -
        // The attribute of Specified-OutsideSqlContext.
        // - - - - - - - - - - - - - - - - - - - - - - -
        final String suffix = buildDbmsSuffix();
        final String sql = outsideSqlContext.readFilteredOutsideSql(_sqlFileEncoding, suffix);
        final Object pmb = outsideSqlContext.getParameterBean();

        // - - - - - - - - - - - - - - -
        // The attribute of SqlCommand.
        // - - - - - - - - - - - - - - -
        final String[] argNames = (pmb != null ? new String[] {"pmb"} : new String[]{});
        final Class<?>[] argTypes = (pmb != null ? new Class<?>[] {pmb.getClass()} : new Class<?>[]{});

        return createUpdateDynamicCommand(argNames, argTypes, sql);
    }

    protected ${glSqlExecution} createOutsideSqlCallCommand(${glOutsideSqlContextName} outsideSqlContext) {
        // - - - - - - - - - - - - - - - - - - - - - - -
        // The attribute of Specified-OutsideSqlContext.
        // - - - - - - - - - - - - - - - - - - - - - - -
        final Object pmb = outsideSqlContext.getParameterBean();
        final String procedureName = outsideSqlContext.getOutsideSqlPath();

        // - - - - - - - - - - - - - - -
        // The attribute of SqlCommand.
        // - - - - - - - - - - - - - - -
        final ${glInternalProcedureMetaDataFactory} factory = createProcedureMetaDataFactory();
        factory.setValueTypeFactory(_valueTypeFactory);
        final Class<?> pmbType = (pmb != null ? pmb.getClass() : null);
        final ${glInternalProcedureMetaData} metaData = factory.createProcedureMetaData(procedureName, pmbType);
        return createProcedureCommand(metaData);
    }

    protected ${glInternalProcedureMetaDataFactory} createProcedureMetaDataFactory() {
        return new ${glInternalProcedureMetaDataFactory}();
    }

    protected ${glInternalProcedureCommand} createProcedureCommand(${glInternalProcedureMetaData} metaData) {
        // Because a procedure command does not use result set handler.
        final ResultSetHandler resultSetHandler = new InternalNullResultSetHandler(); 
        return new ${glInternalProcedureCommand}(_dataSource, resultSetHandler, _statementFactory, metaData);
    }

    // -----------------------------------------------------
    //                                   SelectDynamicCommnd
    //                                   -------------------
    protected ${glSelectDynamicCommand} createSelectDynamicCommand(ResultSetHandler handler, String[] argNames, Class<?>[] argTypes, String sql) {
        final ${glSelectDynamicCommand} cmd = new ${glSelectDynamicCommand}(_dataSource, _statementFactory, handler);
        cmd.setArgNames(argNames);
        cmd.setArgTypes(argTypes);
        if (sql != null) {
            cmd.setSql(sql);
        }
        return cmd;
    }

    // -----------------------------------------------------
    //                                   UpdateDynamicCommnd
    //                                   -------------------
    protected ${glInternalUpdateDynamicCommand} createUpdateDynamicCommand(String[] argNames, Class<?>[] argTypes, String sql) {
        final ${glInternalUpdateDynamicCommand} cmd = new ${glInternalUpdateDynamicCommand}(_dataSource, _statementFactory);
        cmd.setArgNames(argNames);
        cmd.setArgTypes(argTypes);
        if (sql != null) {
            cmd.setSql(sql);
        }
        return cmd;
    }

    // -----------------------------------------------------
    //                                      ResultSetHandler
    //                                      ----------------
    protected ResultSetHandler createObjectResultSetHandler(BeanMetaData bmd) {
        final ${glInternalRowCreator} rowCreator = createInternalRowCreator(bmd);
        final ${glInternalRelationRowCreator} relationRowCreator = createInternalRelationRowCreator(bmd);
        return new ${glInternalBeanListMetaDataResultSetHandler}(bmd, rowCreator, relationRowCreator);
    }

    protected ResultSetHandler createBeanListMetaDataResultSetHandler(BeanMetaData bmd) {
        final ${glInternalRowCreator} rowCreator = createInternalRowCreator(bmd);
        final ${glInternalRelationRowCreator} relationRowCreator = createInternalRelationRowCreator(bmd);
        return new ${glInternalBeanListMetaDataResultSetHandler}(bmd, rowCreator, relationRowCreator);
    }

    protected ResultSetHandler createOutsideSqlBeanListResultSetHandler(BeanMetaData bmd) {
        final ValueType valueType = ValueTypes.getValueType(_entityType);
        if (valueType == null || !valueType.equals(ValueTypes.OBJECT)) {
            return new InternalObjectListResultSetHandler(valueType);
        }
        final ${glInternalRowCreator} rowCreator = createInternalRowCreator(bmd);
        final ${glInternalRelationRowCreator} relationRowCreator = createInternalRelationRowCreator(bmd);
        return new ${glInternalBeanListMetaDataResultSetHandler}(bmd, rowCreator, relationRowCreator);
    }

    protected static class InternalObjectListResultSetHandler implements ResultSetHandler {
        private ValueType valueType;
        public InternalObjectListResultSetHandler(ValueType valueType) {
            this.valueType = valueType;
        }
        public Object handle(ResultSet rs) throws SQLException {
            final List<Object> ret = new ArrayList<Object>();
            while (rs.next()) {
                ret.add(valueType.getValue(rs, 1));
            }
            return ret;
        }
    }

    protected static class InternalNullResultSetHandler implements ResultSetHandler {
        public Object handle(ResultSet rs) throws SQLException {
            return null;
        }
    }

    protected ${glInternalRowCreator} createInternalRowCreator(BeanMetaData bmd) {
        final Class<?> clazz = bmd != null ? bmd.getBeanClass() : null;
        return ${glInternalRowCreator}.createInternalRowCreator(clazz);
    }

    protected ${glInternalRelationRowCreator} createInternalRelationRowCreator(BeanMetaData bmd) {
        return new ${glInternalRelationRowCreator}(); // Not yet implemented about performance tuning!
    }

    // ===================================================================================
    //                                                                       Assist Helper
    //                                                                       =============
    protected String buildDbmsSuffix() {
        final String productName = ${glConditionBeanContextName}.getDatabaseProductName();
        return (productName != null ? "_" + productName.toLowerCase() : "");
    }

    // ===================================================================================
    //                                                                      Basic Override
    //                                                                      ==============
    @Override
    public String toString() {
        return getClass().getSimpleName() + ":{" + buildSqlExecutionKey() + "}";
    }

    // ===================================================================================
    //                                                                            Accessor
    //                                                                            ========
    // -----------------------------------------------------
    //                                     Basic Information
    //                                     -----------------
    public Class<? extends ${glEntityInterfaceName}> getEntityType() {
        return _entityType;
    }

    public void setEntityType(Class<? extends ${glEntityInterfaceName}> entityType) {
        _entityType = entityType;
    }

    public String getTableDbName() {
        return _tableDbName;
    }

    public void setTableDbName(String tableDbName) {
        _tableDbName = tableDbName;
    }

    public void setInitializeOnly(boolean initializeOnly) {
        _initializeOnly = initializeOnly;
    }

    public boolean isInitializeOnly() {
        return _initializeOnly;
    }

    // -----------------------------------------------------
    //                                   Injection Component
    //                                   -------------------
    public void setDataSource(DataSource dataSource) {
        _dataSource = dataSource;
    }

    public void setStatementFactory(StatementFactory statementFactory) {
        _statementFactory = statementFactory;
    }

    public void setBeanMetaDataFactory(BeanMetaDataFactory beanMetaDataFactory) {
        _beanMetaDataFactory = beanMetaDataFactory;
    }

    public void setValueTypeFactory(ValueTypeFactory valueTypeFactory) {
        _valueTypeFactory = valueTypeFactory;
    }

    public void setSqlFileEncoding(String sqlFileEncoding) {
        _sqlFileEncoding = sqlFileEncoding;
    }
}
